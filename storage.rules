
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Allow public read access to all files.
    match /{allPaths=**} {
      allow read;
    }

    // Disallow all writes from the client side.
    // All uploads must go through the secure Cloud Function.
    allow write: if false;

    // Allow writes for authenticated users only to their own profile/document folders.
    // This provides a fallback if the Cloud Function approach still has issues,
    // but the primary method is via the function.
    match /profilePhotos/{userId}/{allPaths=**} {
        allow write: if request.auth != null && request.auth.uid == userId;
    }
    match /documents/{userId}/{allPaths=**} {
        allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
