rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to get user role from their profile
    // Note: Reading user roles within rules can impact performance and cost.
    // Consider using custom claims for roles for better performance if roles are frequently checked in rules.
    function getRole(userId, role) {
      return get(/databases/$(database)/documents/$(role)s/$(userId)).data.role == role;
    }

    // Rules for Passenger profiles
    match /passengers/{passengerId} {
      allow read, update: if isOwner(passengerId);
      allow create: if isAuthenticated(); // Passengers can create their own profile on signup
    }

    // Rules for Driver profiles
    match /drivers/{driverId} {
      // Allow read for authenticated users (passengers, other drivers, fleet managers may need some driver data)
      allow read: if isAuthenticated();
      allow update: if isOwner(driverId); // Drivers can update their own profile
      allow create: if isAuthenticated(); // Drivers can create their own profile on signup
    }

    // Rules for Fleet Manager profiles
    match /fleet-managers/{managerId} {
      allow read, update: if isOwner(managerId); // Fleet managers can read/update their own profile
      allow create: if isAuthenticated(); // Fleet managers can create their own profile on signup
    }
  }
}
