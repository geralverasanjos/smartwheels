rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check for authenticated users
    function isUserAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Passengers: Can read/write their own profile.
    match /passengers/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Fleet Managers: Can read/write their own profile.
    match /fleet-managers/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Drivers: Can be read by their fleet manager or by themselves.
    // Can only be written by themselves.
    match /drivers/{driverId} {
      allow read: if isOwner(driverId) || (exists(/databases/$(database)/documents/fleet-managers/$(request.auth.uid)) && get(/databases/$(database)/documents/drivers/$(driverId)).data.fleetManagerId == request.auth.uid);
      allow write: if isOwner(driverId);
    }
    
    // Vehicles: Can be read by anyone authenticated. Can only be written by their owner driver.
    match /vehicles/{vehicleId} {
      allow read: if isUserAuthenticated();
      allow write: if isOwner(get(/databases/$(database)/documents/vehicles/$(vehicleId)).data.driverId);
    }
    
    // Stands: Can be read or written by any authenticated user.
    match /stands/{standId} {
      allow read, write: if isUserAuthenticated();
    }
    
    // Transactions: Users can create for themselves and read their own.
    match /transactions/{transactionId} {
        allow create: if isOwner(request.resource.data.userId);
        allow read: if isOwner(resource.data.userId);
    }

    // Trips: Can be created by passengers, read by the passenger or the driver involved.
    match /trips/{tripId} {
        allow create: if isUserAuthenticated();
        allow read, update: if isUserAuthenticated() && (isOwner(resource.data.passengerId) || isOwner(resource.data.driverId));
    }
    
    // Ride Requests: Can be created by passengers. Can be read/updated by any authenticated user for now.
    // This allows drivers to see pending requests. A more robust rule would check driver roles.
    match /rideRequests/{requestId} {
      allow create: if isOwner(request.resource.data.passengerId);
      allow read, update: if isUserAuthenticated();
    }

    // Messages: Can be read/written by the passenger or driver involved in the ride.
    match /messages/{messageId} {
       allow read, create: if isUserAuthenticated() && 
          (isOwner(get(/databases/$(database)/documents/rideRequests/$(request.resource.data.rideId)).data.passengerId) || 
           isOwner(get(/databases/$(database)/documents/rideRequests/$(request.resource.data.rideId)).data.driverId));
    }
  }
}