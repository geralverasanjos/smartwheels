
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regra geral: Apenas utilizadores autenticados podem aceder à base de dados.
    // As regras mais específicas abaixo irão sobrepor-se a esta.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // Coleções de Perfis: Os utilizadores só podem ler e escrever no seu próprio perfil.
    match /passengers/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
    }

    match /drivers/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
    }

    match /fleet-managers/{userId} {
      allow read, update, delete: if request.auth.uid == userId;
      allow create: if request.auth.uid == userId;
    }

    // Regras mais específicas para outras coleções (exemplo):
    // Viagens: Motoristas e passageiros podem ler os detalhes da viagem em que participam.
    match /trips/{tripId} {
      allow read: if request.auth.uid == resource.data.driverId || request.auth.uid == resource.data.passengerId;
      allow create: if request.auth != null; // Qualquer utilizador autenticado pode criar um pedido.
    }
    
    // Pedidos de Viagem: Qualquer utilizador autenticado pode criar. Motoristas podem atualizar.
    match /rideRequests/{requestId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null; // Simplificado para permitir a leitura por motoristas e passageiros.
    }

    // Mensagens: Apenas o motorista ou passageiro da viagem podem ler/escrever.
    match /messages/{messageId} {
        allow read, write: if get(/databases/$(database)/documents/trips/$(resource.data.rideId)).data.driverId == request.auth.uid ||
                               get(/databases/$(database)/documents/trips/$(resource.data.rideId)).data.passengerId == request.auth.uid;
    }
    
    // Transações: Utilizadores só podem ler as suas próprias transações.
    match /transactions/{transactionId} {
      allow read: if resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // Outras coleções:
    match /payoutMethods/{methodId} {
       allow read, write, delete: if request.auth.uid == resource.data.userId;
       allow create: if request.auth != null;
    }

     match /vehicles/{vehicleId} {
        allow read, write: if request.auth != null; // Simplificado
     }
     
     match /stands/{standId} {
        allow read, write: if request.auth != null; // Simplificado
     }
     
      match /promotions/{promoId} {
        allow read, write: if request.auth != null; // Simplificado
      }
  }
}
